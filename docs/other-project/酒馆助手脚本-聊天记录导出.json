{
  "type": "script",
  "enabled": true,
  "name": "聊天记录导出",
  "id": "10d58eab-f09d-43dc-b473-0c589f92cf8e",
  "content": {
    "name": 记录导出工具
    description:打开QR，找到“记录导出”使用\n //author:Yellows\n\n(function() {\n    // === 0. 常量 ===\n    const STYLE_ID = 'chat-tool-css-v33';\n    const STORAGE_KEY = 'chat_tool_v33_settings';\n    const BTN_CLASS = 'cet-msg-bookmark-btn'; \n\n    // === 1. 样式 ===\n    $('[id^=chat-tool-css]').remove();\n    $('[id^=chat-export-tool-css]').remove();\n\n    $('head').append(`\n        <style id=\"${STYLE_ID}\">\n            /* 核心布局 */\n            .swal2-popup { \n                width: 95% !important; max-width: 600px !important; padding: 0 !important; \n                display: flex !important; flex-direction: column;\n                height: 80vh !important; max-height: 700px !important;\n            }\n            .swal2-html-container {\n                margin: 0 !important; padding: 0 !important; overflow: hidden !important;\n                text-align: left; flex: 1; display: flex; flex-direction: column;\n            }\n            .cet-wrapper {\n                width: 100%; height: 100%; display: flex; flex-direction: column; \n                padding: 8px; box-sizing: border-box; gap: 6px;\n                background: var(--smart-theme-bg);\n            }\n            .cet-card { display: flex; flex-direction: column; gap: 8px; height: 100%; overflow: hidden; }\n\n            /* 头部 */\n            .cet-header-group { flex-shrink: 0; display: flex; flex-direction: column; gap: 5px; border-bottom: 1px solid var(--smart-theme-border-color-1); padding-bottom: 5px; }\n            .cet-header-row { display: flex; align-items: center; justify-content: space-between; }\n            .cet-title { font-weight: bold; font-size: 1em; display: flex; align-items: center; gap: 6px; }\n            .cet-count { font-size: 0.75em; opacity: 0.6; }\n\n            .cet-tabs { display: flex; gap: 4px; }\n            .cet-tab {\n                flex: 1; text-align: center; padding: 6px; cursor: pointer;\n                font-size: 0.9em; opacity: 0.6; border-bottom: 2px solid transparent;\n                transition: all 0.2s; user-select: none; white-space: nowrap;\n            }\n            .cet-tab:hover { opacity: 0.9; background: rgba(0,0,0,0.03); }\n            .cet-tab.active { opacity: 1; font-weight: bold; border-bottom-color: #7a9a83; color: var(--smart-theme-body-color); }\n\n            /* 滚动内容区 */\n            .cet-scroll-content { flex: 1; overflow-y: auto; overflow-x: hidden; padding-right: 2px; display: flex; flex-direction: column; gap: 8px; }\n            .cet-scroll-content::-webkit-scrollbar { width: 3px; }\n            .cet-scroll-content::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 2px; }\n            .cet-tab-content { display: none; flex-direction: column; gap: 8px; padding-bottom: 5px; }\n            .cet-tab-content.active { display: flex; }\n\n            /* 组件 */\n            .cet-input-group { display: flex; flex-direction: column; gap: 2px; width: 100%; flex-shrink: 0; }\n            .cet-label-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 2px; }\n            .cet-label-title { font-weight: bold; font-size: 0.85em; }\n            .cet-label-desc { font-size: 0.7em; opacity: 0.6; }\n            .cet-input-wrapper { display: flex; gap: 4px; width: 100%; box-sizing: border-box; align-items: center; }\n            .cet-text-input {\n                flex: 1; min-width: 0; background: rgba(0,0,0,0.05); border: 1px solid var(--smart-theme-border-color-1);\n                color: var(--smart-theme-body-color); padding: 6px 8px; border-radius: 4px; font-family: monospace; font-size: 0.85em; height: 30px;\n            }\n            .cet-select {\n                flex: 1; min-width: 0; background: rgba(0,0,0,0.05); border: 1px solid var(--smart-theme-border-color-1);\n                color: var(--smart-theme-body-color); padding: 4px; border-radius: 4px; font-size: 0.8em; max-width: 100%; height: 30px;\n            }\n            .cet-btn-icon {\n                flex-shrink: 0; width: 30px; height: 30px; border: 1px solid var(--smart-theme-border-color-1);\n                background: rgba(0,0,0,0.05); color: var(--smart-theme-body-color); border-radius: 4px;\n                cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 0.9em;\n            }\n            .cet-btn-icon:hover { background: var(--smart-theme-color-red); color: white; border-color: var(--smart-theme-color-red); }\n            .cet-btn-icon.action:hover { background: #7a9a83; color: white; border-color: #7a9a83; }\n            .cet-btn-icon.magic:hover { background: #5b8db8; color: white; border-color: #5b8db8; }\n            .cet-btn-icon.magic.active { background: #5b8db8; color: white; border-color: #5b8db8; }\n            .cet-btn-icon.add { width: auto; padding: 0 8px; font-size: 0.8em; font-weight: bold; }\n            .cet-btn-icon.add:hover { background: #7a9a83; color: white; border-color: #7a9a83; }\n\n            .cet-history-area { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 2px; min-height: 0; }\n            .cet-scan-container {\n                display: none; flex-wrap: wrap; gap: 4px; padding: 6px; margin-bottom: 4px;\n                background: rgba(0,0,0,0.02); border: 1px dashed rgba(0,0,0,0.1); border-radius: 4px;\n                max-height: 100px; overflow-y: auto;\n            }\n            .cet-scan-container::-webkit-scrollbar { width: 3px; }\n            .cet-scan-container::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 2px; }\n\n            .cet-chip {\n                font-size: 0.75em; padding: 2px 6px; background: var(--smart-theme-border-color-1);\n                border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 4px; border: 1px solid transparent; user-select: none;\n            }\n            .cet-chip:hover { border-color: var(--smart-theme-border-color-2); background: rgba(0,0,0,0.1); }\n            .cet-chip.bookmark { background: rgba(122, 154, 131, 0.15); border-color: rgba(122, 154, 131, 0.3); }\n            .cet-chip.bookmark:hover { background: rgba(122, 154, 131, 0.25); }\n            /* 书签 Loading 态 */\n            .cet-chip.bookmark.loading { background: rgba(122, 154, 131, 0.3); pointer-events: none; opacity: 0.8; }\n            \n            .cet-chip.detected { background: rgba(91, 141, 184, 0.15); border-color: rgba(91, 141, 184, 0.3); }\n            .cet-chip.detected:hover { background: rgba(91, 141, 184, 0.25); }\n            .cet-chip.blocking { background: rgba(217, 83, 79, 0.15); border-color: rgba(217, 83, 79, 0.3); }\n            .cet-chip.range { background: rgba(240, 173, 78, 0.15); border-color: rgba(240, 173, 78, 0.3); }\n            .cet-chip.range:hover { background: rgba(240, 173, 78, 0.25); }\n\n            .cet-chip-text { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            .cet-chip-del { font-size: 0.8em; opacity: 0.5; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }\n            .cet-chip-del:hover { background: var(--smart-theme-color-red); color: white; opacity: 1; }\n\n            .cet-options { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; row-gap: 6px; background: rgba(0,0,0,0.03); padding: 6px 8px; border-radius: 6px; flex-shrink: 0; }\n            .cet-checkbox-label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.8em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\n            .cet-checkbox-label input { transform: scale(0.9); margin: 0; }\n\n            .cet-btn {\n                width: 100%; border: none; padding: 8px; border-radius: 6px; font-weight: bold; font-size: 0.9em; color: white;\n                cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 6px; flex-shrink: 0;\n            }\n            .cet-btn.txt { background: #7a9a83; } .cet-btn.txt:hover { background: #6b8c72; }\n            .cet-btn.json { background: #5b8db8; } .cet-btn.json:hover { background: #4a7ca7; }\n            .cet-btn.import { background: transparent; color: var(--smart-theme-body-color); border: 1px solid var(--smart-theme-border-color-2); } .cet-btn.import:hover { background: rgba(0,0,0,0.05); }\n\n            .cet-search-results { flex: 1; min-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.02); border: 1px solid var(--smart-theme-border-color-1); border-radius: 6px; display: flex; flex-direction: column; position: relative; }\n            .cet-search-item { padding: 6px 8px; border-bottom: 1px solid var(--smart-theme-border-color-1); cursor: pointer; font-size: 0.8em; display: flex; flex-direction: column; gap: 2px; }\n            .cet-search-item:last-child { border-bottom: none; }\n            .cet-search-item:hover { background: rgba(122, 154, 131, 0.1); }\n            .cet-search-item.loading { background: rgba(122, 154, 131, 0.2); pointer-events: none; opacity: 0.8; }\n            \n            .cet-res-meta { display: flex; justify-content: space-between; opacity: 0.7; font-size: 0.8em; }\n            .cet-res-content { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--smart-theme-body-color); }\n            .cet-res-match { color: #d9534f; font-weight: bold; }\n            .cet-divider { height: 1px; background: var(--smart-theme-border-color-1); margin: 4px 0; flex-shrink: 0; }\n            \n            .cet-collapse-wrapper { display: flex; justify-content: center; padding: 5px; background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.02)); }\n            .cet-collapse-btn {\n                background: var(--smart-theme-border-color-1); color: var(--smart-theme-body-color);\n                padding: 4px 12px; border-radius: 12px; font-size: 0.75em; cursor: pointer;\n                display: flex; align-items: center; gap: 5px; transition: all 0.2s; border: 1px solid transparent; box-shadow: 0 1px 2px rgba(0,0,0,0.1);\n            }\n            .cet-collapse-btn:hover { background: rgba(122, 154, 131, 0.2); border-color: rgba(122, 154, 131, 0.5); color: #7a9a83; }\n\n            .${BTN_CLASS} { cursor: pointer; opacity: 0.4; margin-left: 5px; display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; transition: all 0.2s; }\n            .${BTN_CLASS}:hover { opacity: 0.8; transform: scale(1.1); }\n            .${BTN_CLASS}.active { opacity: 1; color: #7a9a83; text-shadow: 0 0 2px rgba(122, 154, 131, 0.3); }\n            .cet-btn-icon.block-active { background: #d9534f !important; color: white !important; border-color: #d9534f !important; }\n        </style>\n    `);\n\n    // === 2. 逻辑 ===\n    const Logic = {\n        getCurrentChatKey: () => {\n            if (window.SillyTavern && SillyTavern.getCurrentChatId) return SillyTavern.getCurrentChatId();\n            return \"unknown_chat\";\n        },\n        loadSettings: () => {\n            try {\n                const raw = localStorage.getItem(STORAGE_KEY);\n                const defaults = { \n                    lastExportTags: \"content, small_theater\", \n                    lastSearchTags: \"content, small_theater\", \n                    history: [\"content\", \"small_theater\"], \n                    options: { hidden: true, user: true, showName: true, showFloor: true, clean: true },\n                    bookmarks: {},\n                    ignoredTags: [] \n                };\n                let data = raw ? { ...defaults, ...JSON.parse(raw) } : defaults;\n                if (!data.ignoredTags) data.ignoredTags = [];\n                if (Array.isArray(data.bookmarks)) { \n                    const currentKey = Logic.getCurrentChatKey();\n                    const oldArr = data.bookmarks;\n                    data.bookmarks = {};\n                    if(currentKey) data.bookmarks[currentKey] = oldArr;\n                }\n                return data;\n            } catch { return {}; }\n        },\n        saveSettings: (s) => localStorage.setItem(STORAGE_KEY, JSON.stringify(s)),\n        getCurrentBookmarks: () => {\n            const settings = Logic.loadSettings();\n            const key = Logic.getCurrentChatKey();\n            return settings.bookmarks[key] || [];\n        },\n        saveCurrentBookmarks: (newArr) => {\n            const settings = Logic.loadSettings();\n            const key = Logic.getCurrentChatKey();\n            settings.bookmarks[key] = newArr;\n            Logic.saveSettings(settings);\n        },\n        getProcessedMessages: () => {\n            if (typeof window.TavernHelper === 'undefined') return [];\n            const lastId = window.TavernHelper.getLastMessageId();\n            return window.TavernHelper.getChatMessages(`0-${lastId}`, { include_swipes: false });\n        },\n        getRawMessagesForBackup: () => {\n            if (window.SillyTavern && window.SillyTavern.chat) return window.SillyTavern.chat;\n            return Logic.getProcessedMessages(); \n        },\n        getDefaultFilename: () => {\n            try {\n                let charName = \"Character\", chatTitle = \"Chat\";\n                if (window.SillyTavern && SillyTavern.characters && SillyTavern.characterId) {\n                    const char = SillyTavern.characters[SillyTavern.characterId];\n                    if (char && char.name) charName = char.name;\n                }\n                if (SillyTavern.chatMetadata && SillyTavern.chatMetadata.title) chatTitle = SillyTavern.chatMetadata.title;\n                else if (SillyTavern.getCurrentChatId) {\n                    const chatId = SillyTavern.getCurrentChatId();\n                    if (chatId) chatTitle = chatId.replace(/\\.jsonl?$/, '');\n                }\n                const safeChar = charName.replace(/[\\\\/:*?\"<>|]/g, '').trim();\n                const safeTitle = chatTitle.replace(/[\\\\/:*?\"<>|]/g, '').trim();\n                const date = new Date().toISOString().slice(0, 10);\n                \n                let maxFloor = 0;\n                if (typeof window.TavernHelper !== 'undefined') maxFloor = window.TavernHelper.getLastMessageId();\n\n                let base = safeTitle.toLowerCase().startsWith(safeChar.toLowerCase()) ? `${safeTitle}` : `${safeChar}_${safeTitle}`;\n                return `${base}_${date}_@${maxFloor}`;\n            } catch (e) { return \"Chat_Export_\" + Date.now(); }\n        },\n        download: (content, filename, type = 'text/plain;charset=utf-8') => {\n            if (!content) return false;\n            try {\n                const blob = new Blob([content], { type: type });\n                const url = URL.createObjectURL(blob);\n                const link = document.createElement('a');\n                link.href = url; link.download = filename;\n                document.body.appendChild(link); link.click(); document.body.removeChild(link);\n                URL.revokeObjectURL(url); return true;\n            } catch (e) { return false; }\n        },\n        escapeRegex: (s) => s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'),\n        createHeader: () => JSON.stringify({\n            user_name: window.SillyTavern.name1 || \"User\",\n            character_name: window.SillyTavern.name2 || \"Character\",\n            create_date: Date.now(),\n            chat_metadata: window.SillyTavern.chatMetadata || {}\n        }),\n\n        cleanMessage: (text) => {\n            if (!text) return \"\";\n            let t = text;\n            t = t.replace(/<!--[\\s\\S]*?-->/g, ''); \n            t = t.replace(/<(br|p|div)[^>]*>/gi, '\\n');\n            t = t.replace(/<[^>]+>/g, '');\n            const txt = document.createElement(\"textarea\"); txt.innerHTML = t; t = txt.value;\n            return t.trim();\n        },\n\n        scanUsedTags: () => {\n            const msgs = Logic.getProcessedMessages();\n            const settings = Logic.loadSettings();\n            const userIgnored = new Set(settings.ignoredTags || []);\n            const tagCounts = {};\n            const htmlTags = ['br', 'img', 'p', 'div', 'span', 'audio', 'video', 'strong', 'em', 'u', 's', 'code', 'pre', 'hr', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'input', 'button', 'script', 'style', 'link', 'meta', 'table', 'thead', 'tbody', 'tr', 'td', 'th', 'b', 'i', 'font', 'center', 'strike'];\n            const promptKeywords = ['Rule', 'Setting', 'Engine', 'Directive', 'Logic', 'Flow', 'Diary', 'Table', 'Status', 'Item', 'Phase', 'Abstract', 'Digest', 'Simile', 'Metaphor', 'Guidance', 'Disclaimer', 'UpdateVariable', 'GetVariable'];\n\n            msgs.forEach(msg => {\n                if(!msg.message) return;\n                const matches = [...msg.message.matchAll(/<([a-zA-Z0-9_\\-\\.]+)(?:\\s[^>]*)?>[\\s\\S]*?<\\/\\1>/g)];\n                matches.forEach(m => {\n                    const t = m[1]; const tLower = t.toLowerCase();\n                    if (userIgnored.has(t)) return; \n                    if (htmlTags.includes(tLower)) return; \n                    if (promptKeywords.some(pk => tLower.includes(pk.toLowerCase()))) return; \n                    tagCounts[t] = (tagCounts[t] || 0) + 1;\n                });\n            });\n            return Object.keys(tagCounts).sort((a,b) => tagCounts[b] - tagCounts[a]);\n        },\n        ignoreTag: (tag) => {\n            const settings = Logic.loadSettings();\n            if (!settings.ignoredTags.includes(tag)) { settings.ignoredTags.push(tag); Logic.saveSettings(settings); }\n        },\n\n        jumpTo: (id) => {\n            if (window.TavernHelper && window.TavernHelper.triggerSlash) {\n                // 不使用 Toast, 依赖按钮自身的 Loading 状态变化\n                window.TavernHelper.triggerSlash(`/chat-jump ${id}`);\n                [500, 1000, 2000].forEach(delay => setTimeout(() => Logic.scanAndInject(), delay));\n                return true;\n            } return false;\n        },\n        toggleBookmark: (id, defaultName = \"\") => {\n            const bookmarks = Logic.getCurrentBookmarks(); const idNum = parseInt(id); const index = bookmarks.findIndex(b => b.id === idNum);\n            if (index > -1) {\n                if(confirm(`楼层 #${id} 已在书签中，确定要移除吗？`)) {\n                    bookmarks.splice(index, 1); Logic.saveCurrentBookmarks(bookmarks);\n                    toastr.info(`书签 #${id} 已移除`); Logic.syncAllStates(idNum, false);\n                }\n            } else {\n                const name = prompt(\"添加书签，请输入名称:\", defaultName || `楼层 ${id}`);\n                if (name) {\n                    bookmarks.push({ id: idNum, name: name, date: Date.now() }); bookmarks.sort((a, b) => a.id - b.id);\n                    Logic.saveCurrentBookmarks(bookmarks); toastr.success(`已添加书签: ${name}`); Logic.syncAllStates(idNum, true);\n                }\n            }\n        },\n        isBookmarked: (id) => { const bookmarks = Logic.getCurrentBookmarks(); return bookmarks.some(b => b.id == id); },\n        syncAllStates: (id, isActive) => {\n            const $btn = $(`#chat .mes[mesid=\"${id}\"] .${BTN_CLASS}`);\n            if (isActive) $btn.addClass('active'); else $btn.removeClass('active');\n            const $ui = $('.cet-wrapper'); if ($ui.length > 0) $ui.trigger('cet-bookmark-update');\n        },\n        injectBookmarkButtonToMessage: (mesElement) => {\n            const $mes = $(mesElement); const mesId = $mes.attr('mesid'); if (!mesId) return;\n            const $btnContainer = $mes.find('.mes_buttons'); if ($btnContainer.length === 0) return;\n            if ($btnContainer.find(`.${BTN_CLASS}`).length > 0) return;\n            const $btn = $(`<div class=\"${BTN_CLASS}\" title=\"添加/取消书签\"><i class=\"fa-solid fa-bookmark\"></i></div>`);\n            if (Logic.isBookmarked(mesId)) $btn.addClass('active');\n            $btn.on('click', (e) => { e.stopPropagation(); Logic.toggleBookmark(mesId); });\n            $btnContainer.prepend($btn);\n        },\n        scanAndInject: () => { $('#chat .mes').each(function() { Logic.injectBookmarkButtonToMessage(this); }); },\n        searchMessages: (keyword, tags) => {\n            const msgs = Logic.getProcessedMessages(); if (!keyword) return [];\n            let regex = null;\n            if (tags) {\n                const tagList = tags.split(/[,，]/).map(t => t.trim()).filter(t => t);\n                if (tagList.length > 0) { const safeTags = tagList.map(t => Logic.escapeRegex(t)); const pattern = `<(${safeTags.join('|')})>([\\\\s\\\\S]*?)<\\\\/\\\\1>`; regex = new RegExp(pattern, 'gi'); }\n            }\n            const results = [];\n            msgs.forEach(msg => {\n                let textToSearch = \"\";\n                if (regex) { const matches = [...msg.message.matchAll(regex)]; if (matches.length > 0) textToSearch = matches.map(m => m[2]).join(\" \"); } else textToSearch = msg.message;\n                if (textToSearch && textToSearch.toLowerCase().includes(keyword.toLowerCase())) {\n                    const idx = textToSearch.toLowerCase().indexOf(keyword.toLowerCase());\n                    const start = Math.max(0, idx - 10); const end = Math.min(textToSearch.length, idx + keyword.length + 30);\n                    let snippet = textToSearch.substring(start, end); if (start > 0) snippet = \"...\" + snippet; if (end < textToSearch.length) snippet = snippet + \"...\";\n                    results.push({ id: msg.message_id, name: msg.name, snippet: snippet });\n                }\n            });\n            return results.reverse();\n        },\n        updateTagHistory: (tagInput) => {\n            const settings = Logic.loadSettings();\n            if (tagInput) {\n                const newTags = tagInput.split(/[,，]/).map(t => t.trim()).filter(t => t);\n                let changed = false;\n                newTags.forEach(t => { if (!settings.history.includes(t)) { settings.history.push(t); changed = true; } });\n                if (changed) Logic.saveSettings(settings);\n            }\n        }\n    };\n\n    // === 3. UI ===\n    async function showExportUI() {\n        try {\n            const msgsForTxt = Logic.getProcessedMessages();\n            const settings = Logic.loadSettings();\n            const currentBookmarks = Logic.getCurrentBookmarks();\n            const defaultFilename = Logic.getDefaultFilename();\n            const currentMaxId = msgsForTxt.length > 0 ? msgsForTxt[msgsForTxt.length-1].message_id : 0;\n\n            // 临时状态：导出范围列表 (共享状态)\n            let activeRanges = []; \n\n            const $wrapper = $('<div class=\"cet-wrapper\"></div>');\n            \n            const $card = $(`\n                <div class=\"cet-card\">\n                    <div class=\"cet-header-group\">\n                        <div class=\"cet-header-row\">\n                            <div class=\"cet-title\"><i class=\"fa-solid fa-toolbox\"></i> 记录导出工具</div>\n                            <div class=\"cet-count\">${msgsForTxt.length} 条消息</div>\n                        </div>\n                        <div class=\"cet-tabs\">\n                            <div class=\"cet-tab active\" data-tab=\"tab-nav\">导航/搜索</div>\n                            <div class=\"cet-tab\" data-tab=\"tab-txt\">文本导出</div>\n                            <div class=\"cet-tab\" data-tab=\"tab-json\">数据备份</div>\n                        </div>\n                    </div>\n\n                    <div class=\"cet-scroll-content\">\n                        <!-- TAB 0: 导航 -->\n                        <div class=\"cet-tab-content active\" id=\"tab-nav\">\n                            <div class=\"cet-input-group\">\n                                <div class=\"cet-label-row\"><span class=\"cet-label-title\">楼层跳转 & 书签</span></div>\n                                <div class=\"cet-input-wrapper\">\n                                    <input type=\"number\" class=\"cet-text-input\" id=\"inp-jump-id\" placeholder=\"楼层号 (0-${currentMaxId})\" value=\"${currentMaxId}\">\n                                    <div class=\"cet-btn-icon action\" id=\"btn-do-jump\" title=\"跳转\"><i class=\"fa-solid fa-paper-plane\"></i></div>\n                                    <div class=\"cet-btn-icon action\" id=\"btn-add-bookmark\" title=\"收藏/取消当前输入的楼层\"><i class=\"fa-solid fa-bookmark\"></i></div>\n                                </div>\n                                <div class=\"cet-history-area\" id=\"bookmark-area\"></div>\n                            </div>\n                            <div class=\"cet-divider\"></div>\n                            <div class=\"cet-input-group\">\n                                <div class=\"cet-label-row\"><span class=\"cet-label-title\">关键字搜索</span><span class=\"cet-label-desc\">包含隐藏层</span></div>\n                                <div class=\"cet-input-wrapper\">\n                                    <input type=\"text\" class=\"cet-text-input\" id=\"inp-search-tags\" placeholder=\"标签(选填): content, small_theater\">\n                                    <div class=\"cet-btn-icon magic\" id=\"btn-scan-search-tags\" title=\"扫描/折叠文中标签\"><i class=\"fa-solid fa-wand-magic-sparkles\"></i></div>\n                                    <div class=\"cet-btn-icon\" id=\"btn-clear-search-tags\" title=\"清空标签\"><i class=\"fa-solid fa-trash-can\"></i></div>\n                                </div>\n                                <div class=\"cet-scan-container\" id=\"search-detected-area\"></div>\n                                <div class=\"cet-history-area\" id=\"search-history-area\"></div>\n                                <div class=\"cet-input-wrapper\" style=\"margin-top:2px;\">\n                                    <input type=\"text\" class=\"cet-text-input\" id=\"inp-search-key\" placeholder=\"输入搜索关键字...\">\n                                    <div class=\"cet-btn-icon action\" id=\"btn-do-search\" title=\"搜索\"><i class=\"fa-solid fa-search\"></i></div>\n                                </div>\n                            </div>\n                            <div class=\"cet-search-results\" id=\"search-results-area\" style=\"display:none;\"></div>\n                        </div>\n\n                        <!-- TAB 1: 文本导出 -->\n                        <div class=\"cet-tab-content\" id=\"tab-txt\">\n                            <div class=\"cet-input-group\">\n                                <div class=\"cet-label-row\"><span class=\"cet-label-title\">导出文件名</span></div>\n                                <div class=\"cet-input-wrapper\">\n                                    <input type=\"text\" class=\"cet-text-input\" id=\"inp-filename-txt\">\n                                    <div class=\"cet-btn-icon\" id=\"btn-clear-filename-txt\"><i class=\"fa-solid fa-trash-can\"></i></div>\n                                </div>\n                            </div>\n\n                            <!-- 范围组件占位符 (在JS中渲染) -->\n                            <div id=\"range-settings-txt\"></div>\n\n                            <div class=\"cet-input-group\">\n                                <div class=\"cet-label-row\"><span class=\"cet-label-title\">内容标签筛选</span><span class=\"cet-label-desc\">留空则导出全部</span></div>\n                                <div class=\"cet-input-wrapper\">\n                                    <input type=\"text\" class=\"cet-text-input\" id=\"inp-export-tags\" placeholder=\"如: content, small_theater\">\n                                    <div class=\"cet-btn-icon magic\" id=\"btn-scan-export-tags\" title=\"扫描/折叠文中标签\"><i class=\"fa-solid fa-wand-magic-sparkles\"></i></div>\n                                    <div class=\"cet-btn-icon\" id=\"btn-clear-export-tags\"><i class=\"fa-solid fa-trash-can\"></i></div>\n                                </div>\n                                <div class=\"cet-scan-container\" id=\"export-detected-area\"></div>\n                                <div class=\"cet-history-area\" id=\"export-history-area\"></div>\n                            </div>\n                            \n                            <div class=\"cet-options\">\n                                <label class=\"cet-checkbox-label\" title=\"自动去除代码标签\"><input type=\"checkbox\" id=\"opt-clean\"> 阅读模式 (去除代码)</label>\n                                <label class=\"cet-checkbox-label\"><input type=\"checkbox\" id=\"opt-user\"> 包含用户发言</label>\n                                <label class=\"cet-checkbox-label\"><input type=\"checkbox\" id=\"opt-name\"> 显示发送者</label>\n                                <label class=\"cet-checkbox-label\"><input type=\"checkbox\" id=\"opt-floor\"> 显示楼层号</label>\n                            </div>\n                            \n                            <button class=\"cet-btn txt\" id=\"btn-export-txt\"><i class=\"fa-solid fa-file-lines\"></i> 导出 TXT</button>\n                        </div>\n\n                        <!-- TAB 2: JSONL -->\n                        <div class=\"cet-tab-content\" id=\"tab-json\">\n                            <div style=\"font-size:0.8em;opacity:0.8;background:rgba(0,0,0,0.03);padding:6px;border-radius:6px;line-height:1.4;\">\n                                <i class=\"fa-solid fa-info-circle\"></i> <b>导出无损 JSONL 数据文件</b><br>\n                                支持保存指定楼层范围，用于创建剧情分支 (Branching) 或 备份迁移数据。\n                            </div>\n                            <div class=\"cet-input-group\">\n                                <div class=\"cet-label-row\"><span class=\"cet-label-title\">导出文件名</span></div>\n                                <div class=\"cet-input-wrapper\">\n                                    <input type=\"text\" class=\"cet-text-input\" id=\"inp-filename-json\">\n                                    <div class=\"cet-btn-icon\" id=\"btn-clear-filename-json\"><i class=\"fa-solid fa-trash-can\"></i></div>\n                                </div>\n                            </div>\n\n                            <div id=\"range-settings-json\"></div>\n\n                            <button class=\"cet-btn json\" id=\"btn-export-json\"><i class=\"fa-solid fa-file-export\"></i> 导出聊天数据</button>\n                            <button class=\"cet-btn import\" id=\"btn-import-json\"><i class=\"fa-solid fa-file-import\"></i> 导入聊天数据</button>\n                            <input type=\"file\" id=\"inp-file-json\" style=\"display:none\" accept=\"*\">\n                        </div>\n                    </div>\n                </div>\n            `);\n\n            $wrapper.append($card);\n            let popupInstance = null;\n\n            // === 范围设定组件渲染 ===\n            const renderRangeSettings = (containerId) => {\n                const $container = $wrapper.find(containerId);\n                const html = `\n                    <div class=\"cet-input-group\" style=\"background:rgba(0,0,0,0.02); padding:6px; border-radius:6px; border:1px solid var(--smart-theme-border-color-1);\">\n                        <div class=\"cet-label-row\"><span class=\"cet-label-title\">导出范围 (可选)</span><span class=\"cet-label-desc\">留空则导出全部</span></div>\n                        <div class=\"cet-input-wrapper\">\n                            <input type=\"number\" class=\"cet-text-input inp-range-start\" placeholder=\"起始(默认0)\">\n                            <span style=\"opacity:0.5\">-</span>\n                            <input type=\"number\" class=\"cet-text-input inp-range-end\" placeholder=\"结束(默认Max)\">\n                            <div class=\"cet-btn-icon add btn-add-range\" title=\"添加范围\"><i class=\"fa-solid fa-plus\"></i></div>\n                        </div>\n                        <div class=\"cet-input-wrapper\" style=\"margin-top:2px;\">\n                            <select class=\"cet-select sel-bm-start\"><option value=\"\">选择书签(起)...</option></select>\n                            <select class=\"cet-select sel-bm-end\"><option value=\"\">选择书签(止)...</option></select>\n                        </div>\n                        <div class=\"cet-history-area range-list-area\" style=\"margin-top:2px;\"></div>\n                    </div>\n                `;\n                $container.html(html);\n            };\n            \n            renderRangeSettings('#range-settings-txt');\n            renderRangeSettings('#range-settings-json');\n\n            // === 范围逻辑 ===\n            const updateRangeUI = () => {\n                const bms = Logic.getCurrentBookmarks();\n                let html = '<option value=\"\">选择书签...</option>';\n                bms.forEach(b => html += `<option value=\"${b.id}\">#${b.id} ${_.escape(b.name)}</option>`);\n                $wrapper.find('.sel-bm-start').html(html.replace('选择书签...', '选择书签(起)...'));\n                $wrapper.find('.sel-bm-end').html(html.replace('选择书签...', '选择书签(止)...'));\n\n                $wrapper.find('.range-list-area').empty();\n                if (activeRanges.length > 0) {\n                    activeRanges.forEach((r, idx) => {\n                        const $chip = $(`<div class=\"cet-chip range\"><span>[${r.start} - ${r.end}]</span><div class=\"cet-chip-del\"><i class=\"fa-solid fa-times\"></i></div></div>`);\n                        $chip.find('.cet-chip-del').on('click', () => {\n                            activeRanges.splice(idx, 1);\n                            updateRangeUI();\n                        });\n                        $wrapper.find('.range-list-area').append($chip.clone(true)); \n                    });\n                }\n            };\n            updateRangeUI();\n\n            $wrapper.on('change', '.sel-bm-start', function() { $(this).closest('.cet-input-group').find('.inp-range-start').val(this.value); });\n            $wrapper.on('change', '.sel-bm-end', function() { $(this).closest('.cet-input-group').find('.inp-range-end').val(this.value); });\n            \n            $wrapper.on('click', '.btn-add-range', function() {\n                const $grp = $(this).closest('.cet-input-group');\n                let startRaw = $grp.find('.inp-range-start').val();\n                let endRaw = $grp.find('.inp-range-end').val();\n                \n                let start = startRaw === \"\" ? 0 : parseInt(startRaw);\n                let end = endRaw === \"\" ? currentMaxId : parseInt(endRaw);\n\n                if (isNaN(start) || isNaN(end)) return toastr.warning(\"请输入有效的楼层号\");\n                if (start > end) return toastr.warning(\"起始楼层不能大于结束楼层\");\n                \n                activeRanges.push({ start, end });\n                updateRangeUI();\n                $grp.find('.inp-range-start, .inp-range-end').val('');\n                $grp.find('select').val('');\n            });\n\n            // === 状态保存 ===\n            const saveCurrentState = () => {\n                settings.options = {\n                    clean: $('#opt-clean').is(':checked'),\n                    user: $('#opt-user').is(':checked'),\n                    showName: $('#opt-name').is(':checked'),\n                    showFloor: $('#opt-floor').is(':checked')\n                };\n                settings.lastExportTags = $wrapper.find('#inp-export-tags').val().trim();\n                settings.lastSearchTags = $wrapper.find('#inp-search-tags').val().trim();\n                Logic.saveSettings(settings);\n            };\n\n            $wrapper.find('#inp-filename-txt, #inp-filename-json').val(defaultFilename);\n            $wrapper.find('#inp-export-tags').val(settings.lastExportTags || '');\n            $wrapper.find('#inp-search-tags').val(settings.lastSearchTags || '');\n            \n            $wrapper.find('#opt-clean').prop('checked', settings.options.clean !== false);\n            $wrapper.find('#opt-user').prop('checked', settings.options.user);\n            $wrapper.find('#opt-name').prop('checked', settings.options.showName);\n            $wrapper.find('#opt-floor').prop('checked', settings.options.showFloor);\n\n            $wrapper.find('.cet-tab').on('click', function() {\n                const target = $(this).data('tab');\n                $wrapper.find('.cet-tab').removeClass('active'); $(this).addClass('active');\n                $wrapper.find('.cet-tab-content').removeClass('active'); $wrapper.find('#' + target).addClass('active');\n            });\n\n            // === 扫描/标签逻辑 ===\n            let isBlockMode = false; \n            const renderDetectedTags = (areaId, inputId, tags) => {\n                const $area = $wrapper.find(areaId).empty().show();\n                const $toolbar = $('<div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;\"></div>');\n                $toolbar.append('<span style=\"font-size:0.8em;opacity:0.7;\">扫描结果 (按频率):</span>');\n                const $blockBtn = $(`<div class=\"cet-btn-icon\" style=\"width:24px;height:24px;font-size:0.8em;\" title=\"开启/关闭屏蔽模式 (点击标签将其永久加入黑名单)\"><i class=\"fa-solid fa-ban\"></i></div>`);\n                const toggleBlockMode = () => {\n                    isBlockMode = !isBlockMode;\n                    if(isBlockMode) { $blockBtn.addClass('block-active'); $area.find('.cet-chip.detected').addClass('blocking'); } \n                    else { $blockBtn.removeClass('block-active'); $area.find('.cet-chip.detected').removeClass('blocking'); }\n                };\n                $blockBtn.on('click', toggleBlockMode); $toolbar.append($blockBtn); $area.append($toolbar);\n                const $cloud = $('<div class=\"cet-history-area\"></div>');\n                if (tags.length === 0) { $cloud.append('<span style=\"font-size:0.8em;opacity:0.5;\">未检测到成对标签</span>'); } \n                else {\n                    tags.forEach(tag => {\n                        const $chip = $(`<div class=\"cet-chip detected\"><span>${_.escape(tag)}</span></div>`);\n                        $chip.on('click', () => {\n                            if (isBlockMode) { Logic.ignoreTag(tag); $chip.remove(); } \n                            else { const $inp = $wrapper.find(inputId); let val = $inp.val().trim(); if (!val.includes(tag)) $inp.val(val ? val + \", \" + tag : tag); saveCurrentState(); }\n                        });\n                        $cloud.append($chip);\n                    });\n                }\n                $area.append($cloud);\n            };\n            const handleScan = (areaId, inputId) => {\n                const $area = $wrapper.find(areaId); const btnIcon = $wrapper.find(areaId).prev().find('.magic');\n                if ($area.is(':visible')) { $area.hide(); btnIcon.removeClass('active'); return; }\n                isBlockMode = false; const original = btnIcon.html(); btnIcon.html('<i class=\"fa-solid fa-spinner fa-spin\"></i>');\n                setTimeout(() => {\n                    const tags = Logic.scanUsedTags(); renderDetectedTags(areaId, inputId, tags);\n                    btnIcon.html(original); btnIcon.addClass('active');\n                }, 200);\n            };\n            $wrapper.find('#btn-scan-search-tags').on('click', () => handleScan('#search-detected-area', '#inp-search-tags'));\n            $wrapper.find('#btn-scan-export-tags').on('click', () => handleScan('#export-detected-area', '#inp-export-tags'));\n\n            const renderTagHistoryFor = (areaId, inputId) => {\n                const $area = $wrapper.find(areaId).empty();\n                settings.history.forEach((tag, index) => {\n                    if (!tag) return;\n                    const $chip = $(`<div class=\"cet-chip\"><span>${_.escape(tag)}</span><div class=\"cet-chip-del\"><i class=\"fa-solid fa-times\"></i></div></div>`);\n                    $chip.find('span').on('click', () => {\n                        const $inp = $wrapper.find(inputId); let val = $inp.val().trim(); if (!val.includes(tag)) $inp.val(val ? val + \", \" + tag : tag); saveCurrentState();\n                    });\n                    $chip.find('.cet-chip-del').on('click', () => {\n                        settings.history.splice(index, 1); Logic.saveSettings(settings);\n                        renderTagHistoryFor('#export-history-area', '#inp-export-tags'); renderTagHistoryFor('#search-history-area', '#inp-search-tags');\n                    });\n                    $area.append($chip);\n                });\n            };\n            renderTagHistoryFor('#export-history-area', '#inp-export-tags');\n            renderTagHistoryFor('#search-history-area', '#inp-search-tags');\n\n            $wrapper.find('#inp-export-tags, #inp-search-tags').on('input', saveCurrentState);\n            $wrapper.find('#btn-clear-export-tags').on('click', () => { $wrapper.find('#inp-export-tags').val(''); saveCurrentState(); });\n            $wrapper.find('#btn-clear-search-tags').on('click', () => { $wrapper.find('#inp-search-tags').val(''); saveCurrentState(); });\n\n            const closePopup = () => {\n                if(popupInstance && popupInstance.completeAffirmative) popupInstance.completeAffirmative();\n                else { $('.swal2-confirm').click(); $('.swal2-container').remove(); }\n            };\n\n            $wrapper.find('#btn-do-jump').on('click', function() {\n                const $btn = $(this); const id = parseInt($wrapper.find('#inp-jump-id').val());\n                if (isNaN(id)) return;\n                const originalIcon = $btn.html(); $btn.html('<i class=\"fa-solid fa-spinner fa-spin\"></i>');\n                setTimeout(() => { if (Logic.jumpTo(id)) { closePopup(); } setTimeout(() => $btn.html(originalIcon), 1000); }, 50);\n            });\n\n            const renderBookmarks = () => {\n                const $area = $wrapper.find('#bookmark-area').empty();\n                const bookmarks = Logic.getCurrentBookmarks();\n                if (bookmarks.length === 0) { $area.append('<span style=\"font-size:0.8em;opacity:0.5;padding:4px;\">当前对话暂无书签</span>'); return; }\n                bookmarks.forEach((bm, idx) => {\n                    const $chip = $(`<div class=\"cet-chip bookmark\" title=\"点击跳转至 #${bm.id}\"><span class=\"cet-chip-text\"><i class=\"fa-solid fa-bookmark\" style=\"font-size:0.8em\"></i> ${_.escape(bm.name)} (#${bm.id})</span><div class=\"cet-chip-del\"><i class=\"fa-solid fa-times\"></i></div></div>`);\n                    $chip.find('.cet-chip-text').on('click', function(e) { \n                        e.stopPropagation();\n                        // Loading 状态\n                        const $thisChip = $(this).closest('.cet-chip');\n                        const $icon = $(this).find('i');\n                        const originalClass = $icon.attr('class');\n                        \n                        $thisChip.addClass('loading');\n                        $icon.attr('class', 'fa-solid fa-spinner fa-spin');\n                        \n                        setTimeout(() => {\n                            if(Logic.jumpTo(bm.id)) closePopup();\n                            // 恢复 (万一没关)\n                            setTimeout(() => {\n                                $thisChip.removeClass('loading');\n                                $icon.attr('class', originalClass);\n                            }, 1000);\n                        }, 50);\n                    });\n                    $chip.find('.cet-chip-del').on('click', (e) => { \n                        e.stopPropagation(); bookmarks.splice(idx, 1); Logic.saveCurrentBookmarks(bookmarks); renderBookmarks(); Logic.syncAllStates(bm.id, false); updateRangeUI();\n                    });\n                    $area.append($chip);\n                });\n            };\n            renderBookmarks();\n            $wrapper.on('cet-bookmark-update', () => { renderBookmarks(); updateRangeUI(); });\n\n            $wrapper.find('#btn-add-bookmark').on('click', () => {\n                const id = $wrapper.find('#inp-jump-id').val(); if (id === \"\") return toastr.warning(\"请输入楼层号\");\n                Logic.toggleBookmark(id);\n            });\n\n            $wrapper.find('#btn-do-search').on('click', () => {\n                const key = $wrapper.find('#inp-search-key').val().trim(); const tags = $wrapper.find('#inp-search-tags').val().trim();\n                if (!key) return toastr.warning(\"请输入搜索关键字\");\n                Logic.updateTagHistory(tags);\n                renderTagHistoryFor('#export-history-area', '#inp-export-tags'); renderTagHistoryFor('#search-history-area', '#inp-search-tags');\n                const $resArea = $wrapper.find('#search-results-area').empty().show();\n                $resArea.append('<div style=\"padding:10px;text-align:center;\"><i class=\"fa-solid fa-spinner fa-spin\"></i> 搜索中...</div>');\n                \n                setTimeout(() => {\n                    const results = Logic.searchMessages(key, tags); \n                    $resArea.empty();\n                    if (results.length === 0) { \n                        $resArea.append('<div style=\"padding:10px;text-align:center;opacity:0.6;\">未找到匹配内容</div>'); \n                    } else {\n                        $resArea.append(`<div style=\"padding:5px 10px;font-size:0.8em;opacity:0.6;background:rgba(0,0,0,0.05);\">找到 ${results.length} 条结果 (点击跳转)</div>`);\n                        results.forEach(res => {\n                            const hlSnippet = _.escape(res.snippet).replace(new RegExp(Logic.escapeRegex(key), 'gi'), match => `<span class=\"cet-res-match\">${match}</span>`);\n                            const $item = $(`<div class=\"cet-search-item\"><div class=\"cet-res-meta\"><span>${_.escape(res.name)}</span><span>#${res.id}</span></div><div class=\"cet-res-content\">${hlSnippet}</div></div>`);\n                            \n                            $item.on('click', function() { \n                                const $this = $(this);\n                                $this.addClass('loading');\n                                $this.html('<div style=\"text-align:center;padding:5px;\"><i class=\"fa-solid fa-spinner fa-spin\"></i> 跳转中...</div>');\n                                setTimeout(() => { if(Logic.jumpTo(res.id)) closePopup(); }, 50);\n                            });\n                            $resArea.append($item);\n                        });\n\n                        const $collapseWrapper = $('<div class=\"cet-collapse-wrapper\"></div>');\n                        const $collapseBtn = $(`<div class=\"cet-collapse-btn\"><i class=\"fa-solid fa-chevron-up\"></i> 收起搜索结果</div>`);\n                        $collapseBtn.on('click', () => { $resArea.empty().hide(); });\n                        $collapseWrapper.append($collapseBtn);\n                        $resArea.append($collapseWrapper);\n                    }\n                }, 50);\n            });\n            $wrapper.find('#inp-search-key').on('keypress', (e) => { if(e.which === 13) $wrapper.find('#btn-do-search').click(); });\n\n            $wrapper.find('#btn-clear-filename-txt').on('click', () => $wrapper.find('#inp-filename-txt').val(''));\n            $wrapper.find('#btn-clear-filename-json').on('click', () => $wrapper.find('#inp-filename-json').val(''));\n            $wrapper.find('.cet-options input').on('change', saveCurrentState);\n\n            // === 导出 TXT ===\n            $wrapper.find('#btn-export-txt').on('click', () => {\n                try {\n                    saveCurrentState();\n                    const tagInput = settings.lastExportTags;\n                    Logic.updateTagHistory(tagInput);\n                    renderTagHistoryFor('#export-history-area', '#inp-export-tags'); renderTagHistoryFor('#search-history-area', '#inp-search-tags');\n\n                    let filename = $wrapper.find('#inp-filename-txt').val().trim() || \"export\";\n                    filename = filename.replace(/\\.(json|jsonl)$/i, ''); if (!filename.toLowerCase().endsWith('.txt')) filename += '.txt';\n\n                    const isFullExport = (tagInput === \"\");\n                    const isCleanMode = settings.options.clean;\n                    let regex = null;\n                    if (!isFullExport) {\n                        const tagList = tagInput.split(/[,，]/).map(t => t.trim()).filter(t => t);\n                        if (tagList.length > 0) { const safeTags = tagList.map(t => Logic.escapeRegex(t)); const pattern = `<(${safeTags.join('|')})>([\\\\s\\\\S]*?)<\\\\/\\\\1>`; regex = new RegExp(pattern, 'gi'); }\n                    }\n                    let exportText = \"\", count = 0; const opts = settings.options;\n                    msgsForTxt.forEach(msg => {\n                        if (activeRanges.length > 0) {\n                            const inRange = activeRanges.some(r => msg.message_id >= r.start && msg.message_id <= r.end);\n                            if (!inRange) return;\n                        }\n                        const isUser = msg.role === 'user' || msg.is_user; const isZero = msg.message_id === 0;\n                        let metaParts = []; if (opts.showFloor && msg.message_id !== undefined) metaParts.push(`#${msg.message_id}`);\n                        let prefix = \"\"; if (metaParts.length > 0) prefix += `[${metaParts.join('|')}] `; if (opts.showName) prefix += `【${msg.name}】`; prefix = prefix.trim();\n                        const processContent = (content) => { if (isCleanMode) return Logic.cleanMessage(content); return content.trim(); };\n                        \n                        if ((isUser && opts.user) || isZero) { \n                            if (prefix) exportText += prefix + \"\\n\"; \n                            exportText += processContent(msg.message) + \"\\n\\n--------------------\\n\\n\"; \n                            count++; return; \n                        }\n                        \n                        if (isFullExport) { if (prefix) exportText += prefix + \"\\n\"; exportText += processContent(msg.message) + \"\\n\\n--------------------\\n\\n\"; count++; } \n                        else if (regex) { const matches = [...msg.message.matchAll(regex)]; if (matches.length > 0) { if (prefix) exportText += prefix + \"\\n\"; matches.forEach(m => exportText += processContent(m[2]) + \"\\n\\n\"); exportText += \"--------------------\\n\\n\"; count++; } }\n                    });\n                    if (count === 0) toastr.warning(\"未匹配到内容\"); else if (Logic.download(exportText, filename)) toastr.success(`已导出 TXT (${count}条)`);\n                } catch (err) { toastr.error(\"导出出错: \" + err.message); }\n            });\n\n            // === 导出 JSONL ===\n            $wrapper.find('#btn-export-json').on('click', () => {\n                const rawChat = Logic.getRawMessagesForBackup(); if (!rawChat || rawChat.length === 0) return toastr.warning(\"没有消息\");\n                let filename = $wrapper.find('#inp-filename-json').val().trim() || \"chat_backup\"; filename = filename.replace(/\\.txt$/i, ''); if (!filename.toLowerCase().endsWith('.jsonl')) filename += '.jsonl'; \n                const header = Logic.createHeader(); const lines = [header];\n                let count = 0;\n                rawChat.forEach(msg => { \n                    const item = JSON.parse(JSON.stringify(msg)); \n                    const mId = item.message_id !== undefined ? item.message_id : (item.id || 0); \n                    if (activeRanges.length > 0) {\n                        const inRange = activeRanges.some(r => mId >= r.start && mId <= r.end);\n                        if (!inRange) return;\n                    }\n                    if (item.message !== undefined && item.mes === undefined) item.mes = item.message; lines.push(JSON.stringify(item)); count++;\n                });\n                if (count === 0) return toastr.warning(\"范围内无消息\");\n                if (Logic.download(lines.join('\\n'), filename, 'application/json')) toastr.success(`已导出聊天数据 (${count}条)`);\n            });\n\n            const $fileInput = $wrapper.find('#inp-file-json');\n            $wrapper.find('#btn-import-json').on('click', () => $fileInput.click());\n            $fileInput.on('change', (e) => {\n                const file = e.target.files[0]; if (!file) return;\n                const $btnImport = $wrapper.find('#btn-import-json'); const originalText = $btnImport.html();\n                $btnImport.prop('disabled', true).html('<i class=\"fa-solid fa-spinner fa-spin\"></i> 正在处理...');\n                setTimeout(() => {\n                    const reader = new FileReader();\n                    reader.onload = async (event) => {\n                        try {\n                            const content = event.target.result; let jsonlString = \"\";\n                            try {\n                                const jsonArray = JSON.parse(content);\n                                if (Array.isArray(jsonArray)) { const header = Logic.createHeader(); const lines = [header]; jsonArray.forEach(item => { if (item.message !== undefined && item.mes === undefined) item.mes = item.message; lines.push(JSON.stringify(item)); }); jsonlString = lines.join('\\n'); } else throw new Error(\"Not array\");\n                            } catch {\n                                const lines = content.split('\\n').filter(l => l.trim());\n                                if (lines.length > 0) { const first = JSON.parse(lines[0]); if (first.mes !== undefined || first.message !== undefined) { const header = Logic.createHeader(); jsonlString = header + '\\n' + content; } else jsonlString = content; }\n                            }\n                            const importName = file.name.replace(/\\.(json|jsonl|txt)$/i, '') + \"_imported\";\n                            if (window.TavernHelper && window.TavernHelper.importRawChat) { await window.TavernHelper.importRawChat(importName, jsonlString); toastr.success(`导入成功!`); } else toastr.error(\"TavernHelper 接口不可用\");\n                        } catch (err) { toastr.error(\"导入失败: \" + err.message); } finally { $btnImport.prop('disabled', false).html(originalText); $fileInput.val(''); }\n                    };\n                    reader.readAsText(file);\n                }, 50);\n            });\n\n            if (window.SillyTavern && SillyTavern.Popup) { popupInstance = new SillyTavern.Popup($wrapper, SillyTavern.POPUP_TYPE.TEXT, \"\", { okButton: \"关闭\" }); popupInstance.show(); } \n            else { const popupFunc = SillyTavern.callGenericPopup || window.callGenericPopup; popupFunc($wrapper, 1, \"\", { okButton: \"关闭\" }); }\n        } catch (e) { toastr.error(\"UI加载失败\"); console.error(e); }\n    }\n\n    // === 4. 注册与监听 ===\n    const register = () => {\n        if (window.SillyTavern && SillyTavern.SlashCommandParser) {\n            SillyTavern.SlashCommandParser.addCommandObject(SillyTavern.SlashCommand.fromProps({ name: 'export-ui', callback: showExportUI, helpString: '打开聊天记录工具箱' }));\n        }\n        if (typeof appendInexistentScriptButtons === 'function' && typeof getButtonEvent === 'function') {\n            const BUTTON_NAME = '记录导出';\n            appendInexistentScriptButtons([{ name: BUTTON_NAME, visible: true }]);\n            eventOn(getButtonEvent(BUTTON_NAME), showExportUI);\n        }\n\n        const observerCallback = (mutationsList) => {\n            for (let mutation of mutationsList) {\n                if (mutation.type === 'childList') {\n                    mutation.addedNodes.forEach(node => {\n                        if (node.nodeType === 1) { \n                            if ($(node).hasClass('mes')) Logic.injectBookmarkButtonToMessage(node);\n                            else $(node).find('.mes').each(function() { Logic.injectBookmarkButtonToMessage(this); });\n                        }\n                    });\n                }\n            }\n        };\n        const chatContainer = document.querySelector('#chat');\n        if (chatContainer) {\n            const observer = new MutationObserver(observerCallback);\n            observer.observe(chatContainer, { childList: true, subtree: true });\n        }\n\n        if (window.eventOn && typeof tavern_events !== 'undefined') {\n            window.eventOn(tavern_events.CHAT_CHANGED, () => { \n                $(`.${BTN_CLASS}`).remove();\n                setTimeout(() => Logic.scanAndInject(), 500); \n            });\n            Logic.scanAndInject();\n        }\n    };\n    setTimeout(register, 1000);\n})();"
  },
  "info": "",
  "button": {
    "enabled": true,
    "buttons": [
      {
        "name": "记录导出",
        "visible": true
      }
    ]
  },
  "data": {}
}