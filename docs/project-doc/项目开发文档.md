# Piney (囤囤小兄许) 项目开发文档

## 一、项目概述

### 1.1 项目简介

**Piney (囤囤小兄许)** 是一个 SillyTavern 生态的全能角色卡工作站，专为 AI 角色扮演爱好者打造。不仅提供角色卡的收集、整理、囤积功能，更是一个强大的角色卡编辑器、Prompt 优化工具和创作助手。

**核心定位**：从「囤货工具」升维为「极客生产力工具」——集收藏管理、深度编辑、AI 辅助创作、数据分析于一体的角色卡全生命周期管理平台。

**管理范围**：
- 角色卡（Character Cards）：PNG/JSON 格式
- 聊天记录（Chat Logs）：对话历史解析与分析
- 世界书（World Books/Lorebooks）：词条管理与生成
- 正则脚本（Regex Scripts）：规则收藏与编辑

**安全机制**：采用单用户简易认证模式，通过环境变量配置管理员账号密码，登录后拥有完整权限。

### 1.2 核心功能清单

#### 📦 收藏管理

| 功能 | 说明 |
|-----|------|
| 多格式导入 | PNG/JSON 角色卡、聊天记录、世界书、正则脚本 |
| 批量导入 | 拖拽导入、文件夹扫描 |
| 无损存储 | 完整保留原始文件 |
| 重复检测 | SHA256 哈希去重 + 同名版本管理 |
| 组织管理 | 标签系统、分类目录、收藏夹、自定义合集 |
| 版本管理 | 同角色多版本关联 |
| 回收站 | 软删除，支持恢复 |

#### ✏️ 编辑创作

| 功能 | 说明 |
|-----|------|
| 角色卡编辑器 | 可视化编辑所有字段 |
| Prompt 医生 | AI 诊断优化，Diff 对比，一键应用 |
| 角色融合实验室 | 基因滑块混合两张卡，支持随机突变 |
| 开场白生成器 | 多场景生成，分支预览，直接写入 |
| 对话示例检查器 | 格式纠错 + 角色名一致性检测 |
| 世界书生成器 | 自动词条挖掘、冲突检测、自动链接 |

#### 🤖 AI 智能

| 功能 | 说明 |
|-----|------|
| 自动解析 | 提取 JSON 元数据（支持 V2/V3 格式） |
| AI 简介生成 | 50-150 字中文角色概述 |
| AI 自动标签 | 智能生成描述性标签 |
| Prompt 诊断 | OOC 风险检测、Token 精简建议 |
| 聊天记录解析 | 好感度曲线、记忆碎片提取、高光时刻截取 |

#### 📊 数据分析

| 功能 | 说明 |
|-----|------|
| 角色 DNA 雷达图 | 七维属性可视化，支持对比叠加 |
| Token 热力图 | 实时 Token 计数 + 上下文窗口模拟 |
| 统计看板 | 总量统计、标签分布、评分分布、添加趋势 |

#### ⭐ 自用评分

基于七维评分系统，每项 1-5 星（⭐），允许部分评分，综合分取已评项平均值：

| 维度 | 说明 |
|-----|------|
| 剧情 | 故事线的吸引力和完整度 |
| 逻辑 | 设定的合理性和一致性 |
| 世界观 | 背景设定的丰富程度 |
| 美化 | 描写的文笔和修辞水平 |
| 可玩性 | 重复游玩的价值 |
| 活人感 | 角色是否真实有血有肉 |
| 开场白 | 首条消息的质量和吸引力 |

| 功能 | 说明 |
|-----|------|
| 七维评分 | 剧情/逻辑/世界观/美化/可玩性/活人感/开场白 |
| 综合评分 | 自动计算已打分项的平均值 |
| 笔记系统 | Markdown 格式笔记 |

#### 🔍 搜索发现

| 功能 | 说明 |
|-----|------|
| 全文搜索 | 名称、简介、描述、笔记、标签 |
| 模糊搜索 | 智能匹配，容错查询 |
| 高级筛选 | 分类、标签、评分、日期、状态 |
| 视图切换 | 网格视图 / 列表视图 |
| 随机抽卡 | 每日抽卡 + 塔罗牌模式 |
| 相似推荐 | 基于标签相似度 |

#### 🎮 趣味互动

| 功能 | 说明 |
|-----|------|
| 每日抽卡仪式 | 塔罗牌翻牌 + 今日运势 |
| 连签奖励 | 解锁隐藏皮肤/徽章 |
| 成就系统 | 动态徽章墙（肝帝/杂食党/甚至不是人） |
| 压箱底提醒 | 久未评分的角色愧疚感提示 |

#### � 数据备份

| 功能 | 说明 |
|-----|------|
| 完整备份 | 导出项目所有数据（数据库 + 文件） |
| 一键恢复 | 导入备份文件，完全覆盖当前数据 |
| 数据导出 | JSON/CSV 格式导出 |

### 1.3 技术选型

| 层级 | 技术 | 说明 |
|-----|------|------|
| 编程语言 | Rust + TypeScript | - |
| 核心框架 | Tauri | 稳定支持桌面端 (Win/Mac/Linux) & 移动端 (Android/iOS) |
| 前端框架 | Svelte + SvelteKit | - |
| UI 组件 | shadcn-svelte + TailwindCSS | - |
| 构建工具 | Vite | 标准构建流程 |
| 后端框架 | Axum | 充分利用 Rust 异步生态 |
| 数据库 | SeaORM (Async) + SQLite | 包含自动迁移脚本 (Migration) |
| 序列化 | Serde (JSON) | Rust 标准序列化库 |
| 部署方式 | Docker (Web 模式) / Tauri Bundle (App 模式) | 一套代码，多端分发 |
| 服务端口 | 9696 | 自定义服务端口 |

---

## 二、技术架构

### 2.1 混合模式架构

应用支持两种运行模式，Rust 后端自动检测当前环境：

**Server Mode (Docker 环境)**
- Axum 在 `9696` 端口运行
- 根路径 `/` 托管 Svelte 编译后的静态文件
- 提供 RESTful API 服务
- 适用于远程访问、多设备共享场景

**App Mode (Tauri 环境)**
- Axum 在 localhost:9696 暴露 API 端口
- 前端资源由 Tauri 原生加载
- 提供桌面/移动端原生体验
- 适用于本地使用场景

### 2.2 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         用户界面                                     │
│    ┌─────────────────────┐     ┌─────────────────────────────────┐  │
│    │   Tauri WebView     │     │      浏览器 (Docker Mode)       │  │
│    │   (App Mode)        │     │                                 │  │
│    └──────────┬──────────┘     └──────────────┬──────────────────┘  │
└───────────────┼────────────────────────────────┼────────────────────┘
                │                                │
                ▼                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Svelte 前端 (Stores)                             │
│    ┌────────────────┐  ┌────────────────┐  ┌────────────────────┐   │
│    │ shadcn-svelte  │  │  TailwindCSS   │  │    apiCall()       │   │
│    │   UI 组件      │  │  TailwindCSS   │  │   统一封装          │   │
│    └────────────────┘  └────────────────┘  └─────────┬──────────┘   │
└──────────────────────────────────────────────────────┼──────────────┘
                                                       │
                            HTTP (localhost:9696)      │
                                                       ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Axum API 层                                     │
│    ┌────────────────┐  ┌────────────────┐  ┌────────────────────┐   │
│    │   路由处理      │  │   中间件       │  │   静态文件托管      │   │
│    │   (Handlers)   │  │  (Auth/CORS)   │  │  (Server Mode)     │   │
│    └───────┬────────┘  └────────────────┘  └────────────────────┘   │
└────────────┼────────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     数据层                                          │
│    ┌────────────────┐  ┌────────────────┐  ┌────────────────────┐   │
│    │    SeaORM      │  │    SQLite      │  │    本地文件系统     │   │
│    │   (异步ORM)     │  │   data.db      │  │   (卡片/记录存储)  │   │
│    └────────────────┘  └────────────────┘  └────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 数据流

**导入流程:**
```
PNG/JSON文件 → 前端导入 → Axum API接收 → 提取元数据 → 存储原文件到本地
                                              ↓
                            AI分析生成简介/标签 → 写入SQLite
```

**查询流程:**
```
用户请求 → apiCall() → Axum查询SQLite → 返回元数据 → 前端渲染 → 按需加载图片
```

### 2.4 数据库自动迁移

应用启动时自动执行以下逻辑：
1. 检查 `data/data.db` 是否存在
2. 如果不存在，自动创建数据库文件
3. 运行所有挂起的 SeaORM 迁移 (`Migrator::up`)
4. 确保数据库结构始终与代码版本同步

### 2.5 API 通信封装

前端实现统一的 API 调用函数：`apiCall(path, method, payload)`

该函数特性：
- 智能环境检测
- 在浏览器/Docker 模式中使用 `fetch`
- 在 Tauri 模式中通过 localhost HTTP 请求
- 统一的错误处理和响应格式

---

## 三、项目结构

```
piney/
├── src/                           # Rust 后端源码
│   ├── main.rs                    # 入口，模式检测
│   ├── lib.rs                     # 库导出
│   ├── api/                       # Axum 路由和处理器
│   │   ├── mod.rs
│   │   ├── auth.rs                # 认证相关
│   │   ├── cards.rs               # 角色卡 CRUD
│   │   ├── categories.rs          # 分类管理
│   │   ├── tags.rs                # 标签管理
│   │   ├── collections.rs         # 合集管理
│   │   ├── ratings.rs             # 自用评分
│   │   ├── chat_logs.rs           # 聊天记录
│   │   ├── world_books.rs         # 世界书管理
│   │   ├── regex_scripts.rs       # 正则脚本
│   │   ├── ai.rs                  # AI 分析/诊断/生成
│   │   ├── backup.rs              # 备份与恢复
│   │   ├── stats.rs               # 统计数据
│   │   ├── achievements.rs        # 成就系统
│   │   └── settings.rs            # 系统设置
│   ├── db/                        # SeaORM 数据库层
│   │   ├── mod.rs
│   │   ├── connection.rs          # 连接管理
│   │   └── migrations/            # 数据库迁移
│   ├── entities/                  # SeaORM 实体定义
│   │   ├── mod.rs
│   │   ├── character_card.rs
│   │   ├── category.rs
│   │   ├── tag.rs
│   │   ├── card_tag.rs
│   │   ├── collection.rs
│   │   ├── collection_card.rs
│   │   ├── card_rating.rs
│   │   ├── card_version.rs
│   │   ├── chat_log.rs
│   │   ├── world_book.rs
│   │   ├── world_book_entry.rs
│   │   ├── regex_script.rs
│   │   ├── achievement.rs
│   │   ├── daily_draw.rs
│   │   └── setting.rs
│   ├── services/                  # 业务逻辑层
│   │   ├── mod.rs
│   │   ├── card_service.rs
│   │   ├── png_parser.rs          # PNG 元数据解析
│   │   ├── ai_service.rs          # AI 接口封装
│   │   ├── prompt_doctor.rs       # Prompt 诊断服务
│   │   ├── card_fusion.rs         # 角色融合服务
│   │   ├── chat_analyzer.rs       # 聊天记录解析
│   │   ├── world_book_generator.rs# 世界书生成
│   │   ├── token_analyzer.rs      # Token 分析
│   │   ├── file_service.rs        # 文件存储管理
│   │   ├── hash_service.rs        # 文件哈希计算
│   │   ├── backup_service.rs      # 备份服务
│   │   └── achievement_service.rs # 成就计算
│   ├── models/                    # 请求/响应数据结构
│   │   ├── mod.rs
│   │   ├── request.rs
│   │   └── response.rs
│   └── utils/                     # 工具函数
│       ├── mod.rs
│       ├── mode_detect.rs         # 运行模式检测
│       └── error.rs               # 错误处理
├── src-tauri/                     # Tauri 配置和原生代码
│   ├── Cargo.toml
│   ├── tauri.conf.json
│   ├── src/
│   │   ├── main.rs                # Tauri 入口
│   │   └── lib.rs
│   ├── icons/                     # 应用图标
│   └── capabilities/              # 权限配置
├── frontend/                      # Svelte 前端源码
│   ├── src/
│   │   ├── app.html
│   │   ├── app.css                # 全局样式 + Tailwind
│   │   ├── lib/
│   │   │   ├── api.ts             # apiCall 封装
│   │   │   ├── tokenizer.ts       # Token 计数器
│   │   │   ├── utils.ts           # 工具函数
│   │   │   └── stores/            # Svelte 状态管理
│   │   │       ├── auth.svelte.ts
│   │   │       ├── cards.svelte.ts
│   │   │       ├── achievements.svelte.ts
│   │   │       └── settings.svelte.ts
│   │   ├── components/
│   │   │   ├── ui/                # shadcn-svelte 组件
│   │   │   ├── cards/             # 角色卡相关组件
│   │   │   │   ├── CardGrid.svelte
│   │   │   │   ├── CardDetail.svelte
│   │   │   │   ├── CardEditor.svelte
│   │   │   │   ├── CardImport.svelte
│   │   │   │   ├── SevenDimRating.svelte
│   │   │   │   └── DnaRadar.svelte
│   │   │   ├── ai/                # AI 功能组件
│   │   │   │   ├── PromptDoctor.svelte
│   │   │   │   ├── CardFusion.svelte
│   │   │   │   ├── GreetingGenerator.svelte
│   │   │   │   └── DialogueChecker.svelte
│   │   │   ├── chat/              # 聊天记录组件
│   │   │   │   ├── ChatImporter.svelte
│   │   │   │   ├── AffectionGraph.svelte
│   │   │   │   └── HighlightExporter.svelte
│   │   │   ├── worldbook/         # 世界书组件
│   │   │   │   ├── WorldBookEditor.svelte
│   │   │   │   ├── EntryList.svelte
│   │   │   │   └── ConflictResolver.svelte
│   │   │   ├── token/             # Token 分析组件
│   │   │   │   ├── TokenCounter.svelte
│   │   │   │   └── ContextSimulator.svelte
│   │   │   ├── discovery/         # 发现与抽卡组件
│   │   │   │   ├── DailyDraw.svelte
│   │   │   │   ├── TarotCard.svelte
│   │   │   │   └── RandomPick.svelte
│   │   │   ├── achievements/      # 成就系统组件
│   │   │   │   └── BadgeWall.svelte
│   │   │   ├── backup/            # 备份组件
│   │   │   │   ├── BackupExport.svelte
│   │   │   │   └── BackupImport.svelte
│   │   │   ├── layout/            # 布局组件
│   │   │   │   ├── Sidebar.svelte
│   │   │   │   ├── Header.svelte
│   │   │   │   └── MobileNav.svelte
│   │   │   ├── search/            # 搜索筛选组件
│   │   │   └── stats/             # 统计图表组件
│   │   └── routes/                # SvelteKit 路由
│   │       ├── +layout.svelte
│   │       ├── +page.svelte           # 首页/看板
│   │       ├── login/
│   │       │   └── +page.svelte
│   │       ├── cards/
│   │       │   ├── +page.svelte       # 卡片列表
│   │       │   ├── new/
│   │       │   │   └── +page.svelte   # 新建卡片
│   │       │   └── [id]/
│   │       │       ├── +page.svelte   # 卡片详情
│   │       │       └── edit/
│   │       │           └── +page.svelte # 编辑卡片
│   │       ├── lab/                   # AI 实验室
│   │       │   ├── +page.svelte
│   │       │   ├── doctor/            # Prompt 医生
│   │       │   ├── fusion/            # 角色融合
│   │       │   └── generator/         # 内容生成
│   │       ├── worldbooks/
│   │       │   ├── +page.svelte
│   │       │   └── [id]/
│   │       │       └── +page.svelte
│   │       ├── chatlogs/
│   │       │   ├── +page.svelte
│   │       │   └── [id]/
│   │       │       └── +page.svelte
│   │       ├── categories/
│   │       │   └── +page.svelte
│   │       ├── collections/
│   │       │   ├── +page.svelte
│   │       │   └── [id]/
│   │       │       └── +page.svelte
│   │       ├── daily/                 # 每日抽卡
│   │       │   └── +page.svelte
│   │       ├── achievements/
│   │       │   └── +page.svelte
│   │       ├── backup/                # 备份管理
│   │       │   └── +page.svelte
│   │       ├── trash/
│   │       │   └── +page.svelte
│   │       └── settings/
│   │           └── +page.svelte
│   ├── static/                    # 静态资源
│   ├── package.json
│   ├── svelte.config.js
│   ├── vite.config.ts
│   └── tailwind.config.ts
├── migration/                     # SeaORM CLI 迁移
│   ├── Cargo.toml
│   └── src/
│       ├── lib.rs
│       └── m20240101_000001_create_tables.rs
├── data/                          # 运行时数据目录
│   ├── data.db                    # SQLite 数据库
│   ├── cards/                     # 角色卡原文件
│   ├── thumbnails/                # 缩略图
│   ├── chatlogs/                  # 聊天记录文件
│   ├── worldbooks/                # 世界书文件
│   ├── regex/                     # 正则脚本文件
│   └── backups/                   # 备份文件
├── docker/
│   ├── Dockerfile                 # 多阶段构建
│   └── docker-compose.yml
├── Cargo.toml                     # 工作区配置
├── Cargo.lock
└── README.md
```

---

## 四、功能模块详细设计

### 4.1 Prompt 医生

**核心功能**: AI 驱动的角色卡质量诊断与优化

**诊断能力**:
- OOC (Out of Character) 风险检测：性格与行为不一致警告
- Token 精简建议：过长字段的压缩方案
- 逻辑矛盾检测：设定冲突提示
- 格式规范检查：V2/V3 标准兼容性

**交互方式**:
- 可视化 Diff 对比：左原文/右优化，红删/绿增高亮
- 逻辑诊断书：列出问题原因和修改建议
- 一键应用："接受治疗"按钮替换对应字段
- 选择性采纳：可单独接受或拒绝每项修改

### 4.2 角色融合实验室

**核心功能**: 将两张角色卡混合生成新角色

**融合方式**:
- 基因滑块：为各字段设置混合比例
  - 性格 (50% A - 50% B)
  - 外貌 (20% A - 80% B)
  - 说话方式 (100% A)
- 突变引擎：随机加入不在原卡中的新设定

**输出**:
- 生成新的角色卡草稿
- 可进一步编辑调整
- 保存为独立新卡或关联为版本

### 4.3 聊天记录解析器

**核心功能**: 导入聊天记录，生成角色传记

**解析能力**:
- 好感度曲线 (Affection Graph)：情绪分折线图
- 记忆碎片 (Memory Fragments)：自动提取关键事实
- 高光时刻 (Highlights)：截取名场面生成分享图

**输出**:
- 情绪趋势可视化
- 已知情报清单
- 可分享的高光长图

### 4.4 世界书生成器

**核心功能**: 从多张卡片自动生成世界书

**生成能力**:
- 词条挖掘：识别反复出现的专有名词
- 冲突检测：发现不同卡片中的设定矛盾
- 自动链接：详情页词条高亮悬停解释

**编辑功能**:
- 词条增删改
- 触发关键词配置
- 优先级/深度设置

### 4.5 Token 分析器

**核心功能**: 实时 Token 计数与上下文模拟

**分析能力**:
- 实时预算：编辑时显示 Token 数和费用估算
- 上下文模拟：滑块调节窗口大小 (4k/8k/32k)
- 截断预警：红色标记模型看不见的部分

**热力图展示**:
- 各字段 Token 占比可视化
- 优化建议：哪些字段可压缩

### 4.6 每日抽卡系统

**核心功能**: 仪式感的角色发现机制

**玩法**:
- 塔罗牌模式：3 张盖牌翻 1 张
- 今日运势：附带趣味运势文案
- 连签奖励：解锁皮肤/徽章
- 压箱底提醒：久未评分的角色愧疚感提示

### 4.7 成就系统

**核心功能**: 游戏化的使用激励

**成就类型**:
- 肝帝：总 Token 数突破 100 万
- 杂食党：同时收藏对立标签
- 甚至不是人：收集 50 张非人类角色
- 更多待解锁...

**展示**:
- 动态徽章墙

### 4.8 对话示例检查器

**核心功能**: 检查角色卡中的对话示例格式和一致性

**检查能力**:
- 格式纠错：ST 标准格式 `<START>`，自动识别非标准写法并修正
- 角色名一致性：检测对话示例中的名字是否与卡片名字一致
- 一键标准化：批量修正格式问题

### 4.9 完整备份与恢复

**核心功能**: 项目数据的完整备份与一键恢复

**备份内容**:
- SQLite 数据库 (data.db)
- 角色卡原文件 (cards/)
- 缩略图 (thumbnails/)
- 聊天记录 (chatlogs/)
- 世界书 (worldbooks/)
- 正则脚本 (regex/)
- 系统设置

**恢复方式**:
- 导入备份文件
- **完全覆盖**当前所有数据（非合并）
- 恢复后自动重启应用

---

## 五、数据库设计

### 5.1 ER 关系概览

主要实体：角色卡、分类、标签、合集、自用评分、聊天记录、世界书、正则脚本、成就、每日抽卡

关系：
- 角色卡 ↔ 标签：多对多
- 角色卡 ↔ 分类：多对一
- 角色卡 ↔ 合集：多对多
- 角色卡 ↔ 自用评分：一对一
- 角色卡 ↔ 聊天记录：多对多
- 角色卡 ↔ 世界书：多对多
- 世界书 ↔ 词条：一对多
- 角色卡 ↔ 版本：一对多

### 5.2 核心表结构

#### character_cards（角色卡主表）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | TEXT (UUID) | 主键 |
| file_hash | TEXT | 文件SHA256哈希 |
| file_name | TEXT | 原始文件名 |
| file_size | INTEGER | 文件大小（字节） |
| file_type | TEXT | png / json |
| storage_path | TEXT | 本地存储路径 |
| thumbnail_path | TEXT | 缩略图路径 |
| name | TEXT | 角色名称 |
| description | TEXT | 角色描述 |
| personality | TEXT | 性格设定 |
| scenario | TEXT | 场景设定 |
| first_message | TEXT | 首条消息 |
| mes_example | TEXT | 对话示例 |
| creator_notes | TEXT | 创作者备注 |
| system_prompt | TEXT | 系统提示 |
| raw_json | TEXT (JSON) | 完整原始JSON |
| ai_summary | TEXT | AI生成简介 |
| ai_tags | TEXT (JSON) | AI生成标签 |
| category_id | TEXT (UUID) | 所属分类 |
| user_notes | TEXT | 用户备注 |
| is_favorite | INTEGER | 是否收藏 |
| is_deleted | INTEGER | 软删除标记 |
| deleted_at | TEXT | 删除时间 |
| created_at | TEXT | 创建时间 |
| updated_at | TEXT | 更新时间 |

#### card_ratings（自用评分表）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | TEXT (UUID) | 主键 |
| card_id | TEXT (UUID) | 关联角色卡（唯一） |
| rating_plot | INTEGER | 剧情评分 1-5（可空） |
| rating_logic | INTEGER | 逻辑评分 1-5（可空） |
| rating_worldview | INTEGER | 世界观评分 1-5（可空） |
| rating_polish | INTEGER | 美化评分 1-5（可空） |
| rating_playability | INTEGER | 可玩性评分 1-5（可空） |
| rating_liveliness | INTEGER | 活人感评分 1-5（可空） |
| rating_greeting | INTEGER | 开场白评分 1-5（可空） |
| overall_rating | REAL | 综合评分（已评项平均值） |
| updated_at | TEXT | 更新时间 |

#### chat_logs（聊天记录表）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | TEXT (UUID) | 主键 |
| card_id | TEXT (UUID) | 关联角色卡 |
| file_path | TEXT | 文件存储路径 |
| message_count | INTEGER | 消息数量 |
| total_tokens | INTEGER | 总Token数 |
| affection_data | TEXT (JSON) | 好感度曲线数据 |
| memory_fragments | TEXT (JSON) | 记忆碎片 |
| highlights | TEXT (JSON) | 高光时刻 |
| created_at | TEXT | 创建时间 |

#### world_books（世界书表）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | TEXT (UUID) | 主键 |
| name | TEXT | 世界书名称 |
| description | TEXT | 描述 |
| entry_count | INTEGER | 词条数量 |
| is_auto_generated | INTEGER | 是否自动生成 |
| created_at | TEXT | 创建时间 |
| updated_at | TEXT | 更新时间 |

#### world_book_entries（世界书词条表）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | TEXT (UUID) | 主键 |
| world_book_id | TEXT (UUID) | 所属世界书 |
| keywords | TEXT (JSON) | 触发关键词 |
| content | TEXT | 词条内容 |
| priority | INTEGER | 优先级 |
| depth | INTEGER | 插入深度 |
| is_enabled | INTEGER | 是否启用 |

#### achievements（成就表）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | TEXT | 成就ID (PK) |
| name | TEXT | 成就名称 |
| description | TEXT | 成就描述 |
| icon | TEXT | 图标 |
| unlocked_at | TEXT | 解锁时间 |
| progress | INTEGER | 进度百分比 |

#### daily_draws（每日抽卡记录表）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | TEXT (UUID) | 主键 |
| draw_date | TEXT | 抽卡日期 |
| card_id | TEXT (UUID) | 抽到的卡片 |
| fortune | TEXT | 今日运势 |
| streak_count | INTEGER | 连签天数 |

---

## 六、API 设计

所有 API 端点基于 `/api` 前缀，服务运行在 `9696` 端口。

### 6.1 API 端点总览

#### 身份验证
- POST /api/auth/login
- POST /api/auth/logout
- GET /api/auth/check

#### 角色卡管理
- POST /api/cards/import
- GET /api/cards
- GET /api/cards/:id
- POST /api/cards （新建）
- PATCH /api/cards/:id
- DELETE /api/cards/:id
- POST /api/cards/:id/restore
- DELETE /api/cards/:id/permanent
- POST /api/cards/:id/duplicate
- GET /api/cards/:id/export

#### 自用评分
- GET /api/cards/:id/rating
- PUT /api/cards/:id/rating

#### AI 功能
- POST /api/ai/analyze
- POST /api/ai/batch-analyze
- POST /api/ai/regenerate/:id
- POST /api/ai/doctor/diagnose
- POST /api/ai/doctor/apply
- POST /api/ai/fusion
- POST /api/ai/generate-greeting
- POST /api/ai/check-dialogue

#### 聊天记录
- POST /api/chatlogs/import
- GET /api/chatlogs
- GET /api/chatlogs/:id
- GET /api/chatlogs/:id/analysis
- DELETE /api/chatlogs/:id

#### 世界书
- GET /api/worldbooks
- POST /api/worldbooks
- GET /api/worldbooks/:id
- PATCH /api/worldbooks/:id
- DELETE /api/worldbooks/:id
- POST /api/worldbooks/generate
- GET /api/worldbooks/:id/entries
- POST /api/worldbooks/:id/entries
- PATCH /api/worldbooks/entries/:entryId
- DELETE /api/worldbooks/entries/:entryId

#### 分类/标签/合集
- GET/POST/PATCH/DELETE /api/categories
- GET/POST/PATCH/DELETE /api/tags
- GET/POST/PATCH/DELETE /api/collections

#### Token 分析
- POST /api/token/count
- POST /api/token/simulate

#### 每日抽卡
- GET /api/daily/draw
- GET /api/daily/history
- GET /api/daily/streak

#### 成就系统
- GET /api/achievements
- GET /api/achievements/progress

#### 备份与恢复
- POST /api/backup/create
- GET /api/backup/list
- POST /api/backup/restore
- DELETE /api/backup/:id

#### 数据导出
- POST /api/export/cards
- GET /api/export/database

#### 统计
- GET /api/stats/overview
- GET /api/stats/tags
- GET /api/stats/ratings

#### 设置
- GET /api/settings
- PATCH /api/settings

---

## 七、前端页面

### 7.1 页面清单

| 页面 | 路由 | 说明 |
|-----|------|------|
| 登录 | `/login` | 管理员登录 |
| 首页/看板 | `/` | 统计总览、快捷入口、每日推荐 |
| 全部卡片 | `/cards` | 列表、搜索、筛选、批量操作 |
| 新建卡片 | `/cards/new` | 从零创建角色卡 |
| 卡片详情 | `/cards/[id]` | 完整信息、DNA 雷达图、版本、七维评分 |
| 编辑卡片 | `/cards/[id]/edit` | 可视化编辑器 |
| AI 实验室 | `/lab` | AI 工具入口 |
| Prompt 医生 | `/lab/doctor` | 诊断与优化 |
| 角色融合 | `/lab/fusion` | 混种实验 |
| 内容生成 | `/lab/generator` | 开场白等生成 |
| 世界书列表 | `/worldbooks` | 世界书管理 |
| 世界书详情 | `/worldbooks/[id]` | 词条编辑 |
| 聊天记录 | `/chatlogs` | 记录列表 |
| 记录分析 | `/chatlogs/[id]` | 好感度/记忆/高光 |
| 分类管理 | `/categories` | 分类 CRUD |
| 合集列表 | `/collections` | 合集管理 |
| 合集详情 | `/collections/[id]` | 合集内容 |
| 每日抽卡 | `/daily` | 塔罗牌抽卡 |
| 成就徽章 | `/achievements` | 徽章墙 |
| 备份管理 | `/backup` | 完整备份与恢复 |
| 回收站 | `/trash` | 恢复/永久删除 |
| 设置 | `/settings` | 系统配置 |

### 7.2 响应式布局

| 组件 | 桌面端 | 移动端 |
|-----|-------|-------|
| 侧边栏 | 常驻显示 | 汉堡菜单抽屉 |
| 卡片网格 | 4-5列 | 2列 |
| 详情页 | 左右布局 | 上下布局 |
| 筛选栏 | 横向排列 | 折叠式面板 |
| 编辑器 | 双栏预览 | 单栏切换 |

---

## 八、部署方式

### 8.1 Docker 部署 (优先级 1)

**要求:**
- 极小镜像体积（Alpine 或 Debian-slim）
- 多阶段构建：编译 Rust → 编译 Svelte → 运行时镜像
- 容器内运行 Axum 后端并托管静态文件
- 暴露 `9696` 端口

**数据持久化:** 挂载 `data/` 目录

### 8.2 Tauri 安装包 (优先级 2)

**支持平台:**
- Windows: EXE / MSI
- macOS: DMG / APP
- Linux: AppImage / DEB
- Android: APK
- iOS: IPA

---

## 九、环境变量

| 变量名 | 说明 | 必需 |
|-------|------|------|
| ADMIN_USERNAME | 管理员用户名 | 是 |
| ADMIN_PASSWORD | 管理员密码 | 是 |
| RUN_MODE | 运行模式，可自动检测 | 否 |
| PORT | 服务端口，默认 9696 | 否 |
| DATA_DIR | 数据目录，默认 ./data | 否 |

> AI 接口配置在应用内「设置」页面配置

---

## 十、开发阶段建议

| 阶段 | 内容 | 优先级 |
|-----|------|-------|
| **Phase 1** | 基础框架、数据库、导入、PNG 解析 | P0 |
| **Phase 2** | 卡片 CRUD、列表、分类、标签 | P0 |
| **Phase 3** | 角色卡编辑器 | P0 |
| **Phase 4** | 搜索筛选、排序、视图 | P1 |
| **Phase 5** | AI 简介/标签生成 | P1 |
| **Phase 6** | Prompt 医生 | P1 |
| **Phase 7** | 七维评分系统 | P1 |
| **Phase 8** | Token 分析器 | P1 |
| **Phase 9** | 聊天记录解析 | P2 |
| **Phase 10** | 世界书生成器 | P2 |
| **Phase 11** | 角色融合实验室 | P2 |
| **Phase 12** | 合集、收藏、版本管理 | P2 |
| **Phase 13** | 每日抽卡、成就系统 | P2 |
| **Phase 14** | 统计看板 | P2 |
| **Phase 15** | 完整备份与恢复 | P2 |
| **Phase 16** | 移动端适配、Tauri 打包 | P3 |
| **Phase 17** | Docker 优化、性能调优 | P3 |

---

## 十一、术语表

| 术语 | 说明 |
|-----|------|
| 角色卡 | SillyTavern 使用的 AI 角色定义文件 |
| tEXt 块 | PNG 文件中存储文本元数据的区块 |
| V2/V3 格式 | 角色卡 JSON 标准，包含 spec 和 data 字段 |
| 世界书 | Lorebook，提供背景知识的词条集合 |
| OOC | Out of Character，角色行为与设定不符 |
| Token | 大语言模型的文本计量单位 |
| 上下文窗口 | 模型单次可处理的 Token 上限 |
| DNA 雷达图 | 角色多维属性的可视化图表 |
| 七维评分 | 剧情/逻辑/世界观/美化/可玩性/活人感/开场白 |
| Stores | Svelte 的响应式语法 (writable, readable, derived) |
| Server Mode | Docker 环境下的服务器运行模式 |
| App Mode | Tauri 环境下的本地应用运行模式 |

---

**文档版本**: 2.2  
**项目名称**: Piney (囤囤小兄许)  
**技术栈**: Tauri + Svelte + Rust (Axum) + SQLite + TailwindCSS  
**定位**: SillyTavern 生态的全能角色卡工作站